<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Loading… | DebtReliefGuard</title>
  <meta name="description" content="Loading blog post…" />
  <meta name="robots" content="index,follow" />

  <meta property="og:type" content="article" />
  <meta property="og:title" content="Loading…" />
  <meta property="og:description" content="Loading blog post…" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="/og-cover.jpg" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;color:#111;background:#fff;}
    .wrap{max-width:1040px;margin:0 auto;padding:16px;}
    header.hero{background:#0b3b66;color:#fff;padding:28px 16px;margin:0 0 12px;}
    header.hero h1{margin:0;font-size:1.9rem;line-height:1.2}
    .meta{opacity:.85;margin:.5rem 0 0}
    article{line-height:1.65;font-size:1.05rem}
    .muted{color:#666}
    .hidden{display:none}
    .err{color:#b00020}
  </style>
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <a href="/" style="color:#fff;text-decoration:none;">DebtReliefGuard</a>
      <div class="muted" style="margin-top:4px;"><a href="/blog" style="color:#fff;opacity:.9">Blog</a> ▸ <span id="crumb">Loading…</span></div>
      <h1 id="post-title">Loading…</h1>
      <p id="post-meta" class="meta">Please wait while we load the article.</p>
    </div>
  </header>

  <main class="wrap">
    <div id="notice" class="muted"></div>
    <article id="post-article" class="hidden" aria-live="polite"></article>
    <p id="error" class="muted err hidden">Sorry, we couldn’t load that post.</p>
  </main>

  <script>
  (async () => {
    // ---------- helpers
    const qs = (s) => document.querySelector(s);
    const setText = (sel, t) => { const el=qs(sel); if (el) el.textContent = t || ''; };
    const show = (sel) => { const el=qs(sel); if (el) el.classList.remove('hidden'); };
    const hide = (sel) => { const el=qs(sel); if (el) el.classList.add('hidden'); };
    const normSlug = (s) => String(s||'').trim().replace(/(^\/+|\/+$)/g,'').replace(/\.html$/,'');
    const filename = (url) => {
      try { return normSlug(new URL(url, location.origin).pathname.split('/').pop()); }
      catch { return normSlug(String(url||'').split('/').pop()); }
    };
    const fmtByline = (p) => {
      const d = p?.date_published || p?.published_at || '';
      const dt = d ? new Date(d) : null;
      const dateStr = dt ? dt.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'}) : '';
      const tags = Array.isArray(p?.tags) && p.tags.length ? ' • ' + p.tags.join(', ') : '';
      const author = p?.author || 'DebtReliefGuard';
      return [author, dateStr, tags].filter(Boolean).join(' • ');
    };

    // ---------- identify slug from URL
    const slug = normSlug(location.pathname.replace(/^\/?blog\//,''));
    setText('#crumb', slug || 'Loading…');

    // ---------- meta helpers
    function setMeta(p, href) {
      const title = p?.title || 'Blog Post';
      const desc = p?.excerpt || p?.description || 'Debt relief insights and guides.';
      const image = (p?.image || p?.thumbnail || '/og-cover.jpg');
      const canonical = new URL(href || location.href, location.origin).href;

      document.title = `${title} | DebtReliefGuard`;
      const pairs = [
        ['meta[name="description"]','content', desc],
        ['meta[property="og:title"]','content', title],
        ['meta[property="og:description"]','content', desc],
        ['meta[property="og:url"]','content', canonical],
        ['meta[property="og:image"]','content', image]
      ];
      pairs.forEach(([sel, attr, val]) => { const el = qs(sel); if (el) el.setAttribute(attr, val); });

      const orgId = "https://gatewaydebthelp.com/#gfsr";
      const ld = {
        "@context":"https://schema.org",
        "@type":"Article",
        "headline": title,
        "datePublished": p?.date_published || p?.published_at || undefined,
        "dateModified": p?.date_modified || undefined,
        "image": image ? [image] : undefined,
        "author": {"@type":"Organization","name":"DebtReliefGuard"},
        "publisher": {"@type":"Organization","@id": orgId, "name":"Gateway Financial Settlement Relief, LLC"},
        "mainEntityOfPage": canonical,
        "description": desc
      };
      let tag = document.getElementById('ld-article');
      if (!tag) { tag = document.createElement('script'); tag.type='application/ld+json'; tag.id='ld-article'; document.head.appendChild(tag); }
      tag.textContent = JSON.stringify(ld);
    }

    // ---------- fetchers (resilient)
    async function fetchJSON(url) {
      const res = await fetch(url, { headers:{Accept:'application/json'}, cache:'no-store' });
      if (!res.ok) throw new Error(url + ' HTTP ' + res.status);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if (ct.includes('application/json')) return res.json();
      return JSON.parse(await res.text());
    }
    async function tryFetch(url) {
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.text();
    }

    // ---------- body injection
    function injectArticle(html) {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      let node = doc.querySelector('article, main');
      if (!node) node = doc.body;
      const target = qs('#post-article');
      target.innerHTML = node ? node.innerHTML : html;
      show('#post-article');
    }

    // ---------- telemetry (best-effort; non-blocking)
    function ping(stage, extra) {
      const payload = JSON.stringify({
        stage, slug, at: new Date().toISOString(),
        ua: navigator.userAgent, ref: document.referrer || null, ...extra
      });
      ['/api/015-telemetry-collector','/api/016-telemetry-rollups','/api/050-ai-loop-optimizer','/api/057-heat-map-tracker']
      .forEach(u => fetch(u, { method:'POST', body: payload, headers:{'content-type':'application/json'}, keepalive:true }).catch(()=>{}));
    }

    // ---------- sitemap fallback: find a blog URL that ends with "<slug>.html"
    async function findInSitemap(slug) {
      try {
        const xml = await tryFetch('/sitemap.xml');
        const locs = Array.from(xml.matchAll(/<loc>([^<]+)<\/loc>/g)).map(m => m[1]);
        const hit = locs.find(u => /\/blog\/.+\.html$/i.test(u) && decodeURIComponent(u).endsWith(`${slug}.html`));
        return hit ? new URL(hit, location.origin).pathname : null;
      } catch { return null; }
    }

    // ---------- main logic
    try {
      ping('view_start');
      setText('#post-title', 'Loading…');
      setText('#post-meta', 'Please wait while we load the article.');

      let post = null, href = null;

      // 1) Primary: blogs.json
      try {
        const raw = await fetchJSON('/blogs.json?ts=' + Date.now());
        const list = Array.isArray(raw) ? raw : (Array.isArray(raw?.items) ? raw.items : []);
        post = list.find(x => normSlug(x?.slug) === slug)
            || list.find(x => filename(x?.content_url) === slug || filename(x?.url) === slug)
            || null;
        if (post) {
          href = (post.content_url?.trim()) || (post.url?.trim()) || `/blog/${slug}.html`;
        }
      } catch (e) {
        // swallow; we’ll try fallbacks
      }

      // 2) Fallback A: direct undated file /blog/<slug>.html
      if (!href) {
        try {
          const probe = await fetch(`/blog/${slug}.html`, { method:'HEAD', cache:'no-store' });
          if (probe.ok) href = `/blog/${slug}.html`;
        } catch {}
      }

      // 3) Fallback B: sitemap.xml → dated post that ends with <slug>.html
      if (!href) {
        href = await findInSitemap(slug);
      }

      if (!href) {
        setText('#post-title', 'Post not found');
        setText('#post-meta', '');
        setText('#notice', 'We couldn’t locate this article via blogs.json, direct file, or sitemap. Please confirm the slug matches a file in /blog and/or an entry in /blogs.json.');
        show('#error'); ping('not_found'); return;
      }

      // Meta from post if we have it; otherwise minimal meta
      if (post) {
        setText('#post-title', post.title || 'Untitled');
        setText('#post-meta', fmtByline(post));
        setMeta(post, href);
      } else {
        const titleFromSlug = slug.replace(/[-_]+/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
        setText('#post-title', titleFromSlug);
        setText('#post-meta', '');
        setMeta({ title: titleFromSlug }, href);
      }

      // Fetch and inject the actual article HTML
      const html = await tryFetch(href);
      injectArticle(html);
      ping('view_ok', { href });

    } catch (err) {
      console.error(err);
      setText('#post-title', 'Error loading post');
      setText('#post-meta', '');
      setText('#notice', String(err?.message || err));
      show('#error'); ping('view_error', { error: String(err) });
    }
  })();
  </script>
</body>
</html>
