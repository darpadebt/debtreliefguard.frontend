<script>
/**
 * DebtReliefGuard — Blog Slug Loader (drop-in)
 * --------------------------------------------------------------
 * What it does:
 *  - Detects /blog/<slug> or /blog/<slug>.html
 *  - Loads /blogs.json, finds matching post
 *  - Fetches HTML at post.content_url (or /blog/<slug>/index.html by default)
 *  - Injects sanitized HTML into #post-body (keeps normal markup; strips <script>/<style>)
 *  - Absolutizes relative <img src>, <a href>, etc. against the content file’s directory
 *  - Updates <title>, <meta name=description>, OpenGraph/Twitter tags, canonical
 *  - Replaces boot JSON-LD with proper Article JSON-LD (publisher @id fixed)
 *  - Logs “blog_open” via window.GFSR.log if available (015/057 bridge)
 *
 * Configurable constants: tweak BLOGS_JSON or BLOG_BASE if your structure differs.
 */

(() => {
  const CONFIG = {
    BLOGS_JSON: '/blogs.json',        // <-- change if you keep blogs.json elsewhere
    BLOG_BASE:  '/blog',              // <-- change if your default content lives outside /blog
    PUBLISHER_ID: 'https://gatewaydebthelp.com/#gfsr'
  };

  // ---- DOM helpers ----
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const ensureMetaName = (name) => {
    let m = document.head.querySelector(`meta[name="${name}"]`);
    if (!m) { m = document.createElement('meta'); m.setAttribute('name', name); document.head.appendChild(m); }
    return m;
  };
  const ensureMetaProp = (prop) => {
    let m = document.head.querySelector(`meta[property="${prop}"]`);
    if (!m) { m = document.createElement('meta'); m.setAttribute('property', prop); document.head.appendChild(m); }
    return m;
  };
  const setCanonical = (href) => {
    let l = $('#link-canonical') || document.head.querySelector('link[rel="canonical"]');
    if (!l) { l = document.createElement('link'); l.rel = 'canonical'; document.head.appendChild(l); }
    l.href = href;
  };

  const setSEO = ({title, desc, url, img}) => {
    document.title = `${title} | DebtReliefGuard Blog`;
    ensureMetaName('description').setAttribute('content', desc || 'Debt relief insights.');

    (document.getElementById('og-title')  || ensureMetaProp('og:title'))       .setAttribute('content', title);
    (document.getElementById('og-description') || ensureMetaProp('og:description')).setAttribute('content', desc || 'Debt relief insights.');
    (document.getElementById('og-url')    || ensureMetaProp('og:url'))         .setAttribute('content', url);
    (document.getElementById('og-image')  || ensureMetaProp('og:image'))       .setAttribute('content', img);

    (document.getElementById('tw-title')  || ensureMetaName('twitter:title'))  .setAttribute('content', title);
    (document.getElementById('tw-desc')   || ensureMetaName('twitter:description')).setAttribute('content', desc || 'Debt relief insights.');
    (document.getElementById('tw-image')  || ensureMetaName('twitter:image'))  .setAttribute('content', img);

    setCanonical(url);
  };

  const setJSONLD = (obj) => {
    const s = document.createElement('script');
    s.type = 'application/ld+json';
    s.textContent = JSON.stringify(obj);
    const boot = document.getElementById('jsonld-boot');
    if (boot) boot.replaceWith(s);
    else document.head.appendChild(s);
  };

  const fmtDate = (d) => {
    try { return new Date(d).toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'}); }
    catch { return d || ''; }
  };

  // ---- URL helpers ----
  const getSlug = () => {
    // Supports /blog/<slug> and /blog/<slug>.html
    const m = location.pathname.match(/^\/blog\/([^\/]+?)(?:\.html)?\/?$/i);
    return m ? decodeURIComponent(m[1]) : null;
  };
  const toAbs = (value, baseURL) => {
    if (!value) return value;
    if (/^(#|mailto:|tel:|javascript:)/i.test(value)) return value; // leave anchors/mail/tel
    try { return new URL(value, baseURL).href; } catch { return value; }
  };

  // ---- Content sanitizer & absolutizer ----
  const sanitizeAndAbsolutize = (html, baseURL) => {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;

    // Strip only risky tags; keep semantic content
    tmp.querySelectorAll('script, style, link[rel="stylesheet"], meta, title').forEach(n => n.remove());

    // Absolutize resources/links
    tmp.querySelectorAll('[src]').forEach(el => {
      const v = el.getAttribute('src'); el.setAttribute('src', toAbs(v, baseURL));
    });
    tmp.querySelectorAll('a[href]').forEach(el => {
      const v = el.getAttribute('href'); el.setAttribute('href', toAbs(v, baseURL));
    });
    tmp.querySelectorAll('source[srcset], img[srcset]').forEach(el => {
      const v = el.getAttribute('srcset');
      if (!v) return;
      const parts = v.split(',').map(s => {
        const [u, w] = s.trim().split(/\s+/);
        return [toAbs(u, baseURL), w].filter(Boolean).join(' ');
      });
      el.setAttribute('srcset', parts.join(', '));
    });

    return tmp;
  };

  // ---- Main loader ----
  (async function run() {
    const TITLE  = $('#post-title');
    const META   = $('#post-meta');
    const BODY   = $('#post-body');
    const PMEDIA = $('#post-media');
    const PIMG   = $('#post-image');
    const ERR    = $('#post-error');

    const slug = getSlug();
    if (!slug) {
      if (TITLE) TITLE.textContent = 'Post not found';
      if (BODY)  BODY.innerHTML = '<p>We couldn’t detect a valid blog URL.</p>';
      if (ERR)   ERR.hidden = false;
      return;
    }

    try {
      // 1) Load blogs.json
      const r = await fetch(`${CONFIG.BLOGS_JSON}?ts=${Date.now()}`, {cache:'no-store', headers:{'Accept':'application/json'}});
      if (!r.ok) throw new Error(`blogs.json HTTP ${r.status}`);
      const ct = (r.headers.get('content-type') || '').toLowerCase();
      if (!ct.includes('application/json')) throw new Error('blogs.json not JSON');

      const data = await r.json();
      const posts = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
      if (!posts.length) throw new Error('No posts in blogs.json');

      // Optional site filter if you list multiple sites in one JSON
      const host = location.hostname;
      const site = host.includes('debtreliefguard') ? 'debtreliefguard'
                 : host.includes('debthelpform')    ? 'debthelpform'
                 : undefined;
      const list = site ? posts.filter(p => (p.site||'').toLowerCase() === site) : posts;

      // 2) Find matching post by slug or content_url
      const targetHTML = `${CONFIG.BLOG_BASE}/${slug}.html`;
      const post = list.find(p =>
        String(p.slug||'').toLowerCase() === slug.toLowerCase() ||
        String(p.content_url||'').toLowerCase() === targetHTML.toLowerCase() ||
        String(p.content_url||'').toLowerCase() === `${CONFIG.BLOG_BASE}/${slug}/index.html`.toLowerCase()
      );

      if (!post) {
        if (TITLE) TITLE.textContent = 'Post not found';
        if (BODY)  BODY.innerHTML = `<p>We couldn’t find an article for <code>${slug}</code>.</p>`;
        if (ERR)   ERR.hidden = false;
        return;
      }

      // 3) Resolve content URL (default to folder index.html under BLOG_BASE)
      const contentURL = post.content_url || `${CONFIG.BLOG_BASE}/${slug}/index.html`;
      const res = await fetch(contentURL + (contentURL.includes('?') ? '&' : '?') + 'ts=' + Date.now(), {cache:'no-store'});
      if (!res.ok) throw new Error(`content_url HTTP ${res.status}`);
      const html = await res.text();

      // 4) Sanitize and absolutize against the content file’s directory
      const base = new URL(contentURL, location.origin);
      // Ensure base points to directory (…/index.html → …/)
      const baseDir = new URL('.', base).href;
      const safe = sanitizeAndAbsolutize(html, baseDir);

      // 5) Inject content into #post-body
      if (BODY) {
        BODY.innerHTML = '';
        while (safe.firstChild) BODY.appendChild(safe.firstChild);
      }

      // 6) Compute SEO fields
      const pageTitle = post.title || (TITLE?.textContent?.trim()) || slug.replace(/-/g,' ').replace(/\b\w/g, m=>m.toUpperCase());
      const pageDesc  = (post.excerpt || '').replace(/^#+\s*/, '').trim() || 'Debt relief insights.';
      const pageURL   = new URL(`${CONFIG.BLOG_BASE}/${slug}.html`, location.origin).href;
      const pageImg   = post.thumbnail ? new URL(post.thumbnail, location.origin).href
                                       : new URL('/og-cover.jpg', location.origin).href;

      // 7) Visible header + meta line
      if (TITLE) TITLE.textContent = pageTitle;
      if (META) {
        const dt = post.date_published ? fmtDate(post.date_published) : '';
        const who = post.author ? ` • ${post.author}` : '';
        const tags = Array.isArray(post.tags) && post.tags.length ? ` • ${post.tags.join(', ')}` : '';
        META.textContent = [dt, who, tags].filter(Boolean).join('');
      }

      // Optional top image block
      if (post.thumbnail && PIMG && PMEDIA) {
        PIMG.src = pageImg; PIMG.alt = pageTitle; PMEDIA.hidden = false;
      }

      // 8) Update meta tags and canonical
      setSEO({ title: pageTitle, desc: pageDesc, url: pageURL, img: pageImg });

      // 9) Replace JSON-LD with Article
      setJSONLD({
        "@context":"https://schema.org",
        "@type":"Article",
        "headline": pageTitle,
        "description": pageDesc,
        "image": [pageImg],
        "mainEntityOfPage": pageURL,
        "datePublished": post.date_published || undefined,
        "dateModified": new Date().toISOString(),
        "author": {"@type":"Organization","name":"Gateway Financial Settlement Relief, LLC"},
        "publisher":{"@id": CONFIG.PUBLISHER_ID},
        "keywords": Array.isArray(post.tags) ? post.tags.join(', ') : ''
      });

      // 10) Telemetry hook if available (015/057)
      try { window.GFSR && typeof window.GFSR.log === 'function' && window.GFSR.log('blog_open', { slug, url: pageURL }); } catch {}

    } catch (err) {
      console.error('[blog slug loader] ', err);
      if ($('#post-title')) $('#post-title').textContent = 'Temporary error';
      if ($('#post-error')) $('#post-error').hidden = false;
      try { window.GFSR && typeof window.GFSR.log === 'function' && window.GFSR.log('blog_error', { slug: location.pathname, err: String(err) }); } catch {}
    }
  })();
})();
</script>
