<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Defaults (will be replaced by JS once post loads) -->
  <title>Loading… | DebtReliefGuard</title>
  <meta name="description" content="Loading blog post…" />
  <meta name="robots" content="index,follow" />

  <!-- Open Graph (will be replaced by JS) -->
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Loading…" />
  <meta property="og:description" content="Loading blog post…" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="/og-cover.jpg" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;color:#111;background:#fff;}
    .wrap{max-width:1040px;margin:0 auto;padding:16px;}
    header.hero{background:#0b3b66;color:#fff;padding:28px 16px;margin:0 0 12px;}
    header.hero h1{margin:0;font-size:1.9rem;line-height:1.2}
    .meta{opacity:.85;margin:.5rem 0 0}
    article{line-height:1.65;font-size:1.05rem}
    .muted{color:#666}
    .hidden{display:none}
  </style>
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <a href="/" style="color:#fff;text-decoration:none;">DebtReliefGuard</a>
      <div class="muted" style="margin-top:4px;"><a href="/blog" style="color:#fff;opacity:.9">Blog</a> ▸ <span id="crumb">Loading…</span></div>
      <h1 id="post-title">Loading…</h1>
      <p id="post-meta" class="meta">Please wait while we load the article.</p>
    </div>
  </header>

  <main class="wrap">
    <div id="notice" class="muted"></div>
    <article id="post-article" class="hidden" aria-live="polite"></article>
    <p id="error" class="muted hidden">Sorry, we couldn’t load that post.</p>
  </main>

  <script>
  (async () => {
    // ---------- helpers
    const qs = (s) => document.querySelector(s);
    const setText = (sel, t) => { const el=qs(sel); if (el) el.textContent = t || ''; };
    const show = (sel) => { const el=qs(sel); if (el) el.classList.remove('hidden'); };
    const hide = (sel) => { const el=qs(sel); if (el) el.classList.add('hidden'); };
    const byline = (p) => {
      const d = p.date_published || p.published_at || '';
      const dt = d ? new Date(d) : null;
      const dateStr = dt ? dt.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'}) : '';
      const tags = Array.isArray(p.tags) && p.tags.length ? ' • ' + p.tags.join(', ') : '';
      const author = p.author || 'DebtReliefGuard';
      return [author, dateStr, tags].filter(Boolean).join(' • ');
    };
    const normSlug = (s) => String(s||'').trim().replace(/(^\/+|\/+$)/g,'').replace(/\.html$/,'');
    const filename = (url) => {
      try { return normSlug(new URL(url, location.origin).pathname.split('/').pop()); }
      catch { return normSlug(String(url||'').split('/').pop()); }
    };

    // ---------- 1) get slug from URL (/blog/<slug>[.html])
    const path = location.pathname;
    const slug = normSlug(path.replace(/^\/?blog\//,''));

    // ---------- 2) fetch blogs.json (no-cache)
    async function loadCatalog() {
      const res = await fetch('/blogs.json?ts=' + Date.now(), {
        headers: { 'Accept': 'application/json' },
        cache: 'no-store'
      });
      if (!res.ok) throw new Error('blogs.json HTTP ' + res.status);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if (ct.includes('application/json')) return res.json();
      return JSON.parse(await res.text());
    }

    // ---------- 3) choose the matching post
    function findPost(list, slug) {
      if (!Array.isArray(list)) list = Array.isArray(list?.items) ? list.items : [];
      // direct slug match
      let p = list.find(x => normSlug(x.slug) === slug);
      if (p) return p;
      // fallback: match by filename of content_url
      p = list.find(x => filename(x.content_url) === slug || filename(x.url) === slug);
      return p || null;
    }

    // ---------- 4) set SEO/meta from post record
    function setMeta(p, href) {
      const title = p.title || 'Blog Post';
      const desc = p.excerpt || p.description || 'Debt relief insights and guides.';
      const image = (p.image || p.thumbnail || '/og-cover.jpg');
      const canonical = new URL(href || location.href, location.origin).href;

      document.title = `${title} | DebtReliefGuard`;
      [
        ['meta[name="description"]','content', desc],
        ['meta[property="og:title"]','content', title],
        ['meta[property="og:description"]','content', desc],
        ['meta[property="og:url"]','content', canonical],
        ['meta[property="og:image"]','content', image]
      ].forEach(([sel, attr, val]) => { const el = qs(sel); if (el) el.setAttribute(attr, val); });

      // Article JSON-LD
      const orgId = "https://gatewaydebthelp.com/#gfsr";
      const ld = {
        "@context":"https://schema.org",
        "@type":"Article",
        "headline": title,
        "datePublished": p.date_published || p.published_at || undefined,
        "dateModified": p.date_modified || undefined,
        "image": image ? [image] : undefined,
        "author": {"@type":"Organization","name":"DebtReliefGuard"},
        "publisher": {"@type":"Organization","@id": orgId, "name":"Gateway Financial Settlement Relief, LLC"},
        "mainEntityOfPage": canonical,
        "description": desc
      };
      let tag = document.getElementById('ld-article');
      if (!tag) { tag = document.createElement('script'); tag.type='application/ld+json'; tag.id='ld-article'; document.head.appendChild(tag); }
      tag.textContent = JSON.stringify(ld);
    }

    // ---------- 5) fetch the real HTML file and inject its <article> (or fallback)
    async function loadAndInject(url) {
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) throw new Error('post HTML HTTP ' + res.status);
      const html = await res.text();
      // try to extract <article> or <main>
      const doc = new DOMParser().parseFromString(html, 'text/html');
      let node = doc.querySelector('article, main');
      // fallback: try body content
      if (!node) node = doc.body;
      const target = qs('#post-article');
      target.innerHTML = node ? node.innerHTML : html;
      show('#post-article');
    }

    // ---------- 6) telemetry (best-effort; non-blocking; ignores errors)
    function pingTelemetry(stage, extra) {
      const base = (p) => ({
        stage, slug,
        title: p?.title || null,
        at: new Date().toISOString(),
        userAgent: navigator.userAgent,
        ref: document.referrer || null,
        ...extra
      });
      const ents = [
        ['/api/015-telemetry-collector', {}],
        ['/api/016-telemetry-rollups', {}],
        ['/api/050-ai-loop-optimizer', {}],
        ['/api/057-heat-map-tracker', {}]
      ];
      ents.forEach(([url, opt]) => {
        fetch(url, { method:'POST', body: JSON.stringify(base()), headers:{'content-type':'application/json'}, keepalive:true, ...opt })
          .catch(()=>{});
      });
    }

    try {
      setText('#crumb', slug || 'Loading…');
      const catalog = await loadCatalog();
      const post = findPost(catalog, slug);

      if (!post) {
        setText('#post-title', 'Post not found');
        setText('#post-meta', '');
        setText('#notice', 'We couldn’t find a post with that address. If this was a dated article, please verify the filename in /blog and the slug in blogs.json match.');
        show('#error');
        pingTelemetry('not_found');
        return;
      }

      const href = (post.content_url?.trim()) || (post.url?.trim()) || `/blog/${slug}.html`;
      setText('#post-title', post.title || 'Untitled');
      setText('#post-meta', byline(post));
      setMeta(post, href);
      pingTelemetry('view_start', {href});

      await loadAndInject(href);

      pingTelemetry('view_ok', {href});
    } catch (err) {
      console.error(err);
      setText('#post-title', 'Error loading post');
      setText('#post-meta', '');
      setText('#notice', String(err.message || err));
      show('#error');
      pingTelemetry('view_error', {error:String(err)});
    }
  })();
  </script>
</body>
</html>
